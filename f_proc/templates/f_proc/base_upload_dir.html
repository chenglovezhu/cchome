<div class="w-75 mx-auto">
  <div class="d-flex flex-column align-items-center">
    <div class="row w-100">
      <div class="col">
        <label class="m-1 pull-left" for="categorySelect">文件分类</label>
        <select
          id="categorySelect"
          class="form-select"
          aria-label="选择文件分类"
          name="categorySelect"
        >
          <option selected>选择分类......</option>
          {% for category in categories %}
          <option value="{{ category.id }}">{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col">
        <label class="m-1 pull-left" for="levelSelect">文件级别</label>
        <select
          id="levelSelect"
          class="form-select"
          aria-label="选择文件级别"
          name="levelSelect"
        >
          <option selected>选择文件等级</option>
          <option value="SFW">SFW</option>
          <option value="Sketchy">Sketchy</option>
          <option value="NSFW">NSFW</option>
        </select>
      </div>
    </div>
    
    <div class="row w-100 mt-4">
      <div class="col">
        <label class="m-1 pull-left" for="manyTags">文件标签</label>
        <input
          type="text"
          class="form-control rounded-3"
          id="manyTags"
          placeholder="输入标签（以逗号分隔）"
        />
      </div>
    </div>

    <div class="row w-100 rounded-3 mt-4">
      <div class="col">
        <label class="m-1 pull-left" for="folderInput">选择上传文件</label>
        <input
          type="file"
          class="form-control rounded-3 bg-white"
          id="folderInput"
          webkitdirectory
          multiple
        />
      </div>
    </div>
  </div>
  
  <div class="mt-3">
    <button class="btn btn-primary me-3 pull-right" id="uploadButton">Go</button>
  </div>
  
  <div id="fileList" style="margin-top: 20px;"></div>
</div>

<script>
  const csrfMetaTag = document.querySelector('meta[name="csrf-token"]');
  const csrfToken = csrfMetaTag ? csrfMetaTag.getAttribute("content") : null;

  if (!csrfToken) {
    console.error("CSRF meta tag not found!");
  }

  document.getElementById("uploadButton").addEventListener("click", function () {
    const input = document.getElementById("folderInput");
    const files = input.files;

    if (files.length === 0) {
      console.warn("没有选择文件。");
      return;
    }

    document.getElementById("fileList").innerHTML = "";

    Array.from(files).forEach((file) => {
      const [album, subject] = file.webkitRelativePath.split("/");
      const fileItem = document.createElement("div");
      fileItem.classList.add("mt-2", "border", "p-2", "rounded", "shadow-sm");
      fileItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <span>文件名: ${file.name}</span>
          <span class="upload-status"></span>
        </div>
        <div class="progress mt-2">
          <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      `;
      document.getElementById("fileList").appendChild(fileItem);

      const formData = new FormData();
      formData.append("file_field", file);
      formData.append("album", album);
      formData.append("subject", subject);
      formData.append("categorySelect", document.getElementById("categorySelect").value);
      formData.append("levelSelect", document.getElementById("levelSelect").value);
      formData.append("manyTags", document.getElementById("manyTags").value);

      uploadFile(formData, fileItem);
    });
  });

  function uploadFile(formData, fileItem) {
    const xhr = new XMLHttpRequest();
    xhr.open("POST", '{% url "save_file_data" %}');
    xhr.setRequestHeader("X-CSRFToken", csrfToken);

    xhr.upload.onprogress = function (event) {
      if (event.lengthComputable) {
        const percentComplete = (event.loaded / event.total) * 100;
        const progressBar = fileItem.querySelector(".progress-bar");
        progressBar.style.width = percentComplete + "%";
        progressBar.setAttribute("aria-valuenow", percentComplete);
      }
    };

    xhr.onload = function () {
      if (xhr.status === 200) {
        try {
          const response = JSON.parse(xhr.responseText);
          handleUploadResponse(response, fileItem);
        } catch (e) {
          console.error("响应解析失败:", e);
          updateUploadStatus(fileItem, "响应解析失败", "text-danger");
        }
      } else {
        updateUploadStatus(fileItem, "上传失败", "text-danger");
      }
    };

    xhr.onerror = function () {
      console.error("请求发生错误");
      updateUploadStatus(fileItem, "请求错误", "text-danger");
    };

    xhr.send(formData);
  }

  function handleUploadResponse(response, fileItem) {
    const fileName = fileItem.querySelector('span').textContent.replace('文件名: ', '');
    if (response.successful.length > 0 && response.successful.some(f => f.name === fileName)) {
      updateUploadStatus(fileItem, "上传成功", "text-success");
      setProgress(fileItem, "上传成功");
    } else if (response.exist.length > 0 && response.exist.some(f => f.name === fileName)) {
      const file = response.exist.find((f) => f.name === fileName);
      updateUploadStatus(fileItem, `${file.md5}已存在`, "text-warning");
      setProgress(fileItem, "文件存在");
    } else if (response.failed.length > 0 && response.failed.some(f => f.name === fileName)) {
      updateUploadStatus(fileItem, "上传失败", "text-danger");
      setProgress(fileItem, "上传失败");
    }
  }

  function updateUploadStatus(fileItem, message, statusClass) {
    const statusSpan = fileItem.querySelector('.upload-status');
    statusSpan.textContent = message;
    statusSpan.className = `ms-2 ${statusClass}`; // 添加 margin 左边距
  }

  function setProgress(fileItem, status) {
    const progressBar = fileItem.querySelector(".progress-bar");
    if (status === "上传成功") {
      progressBar.style.width = "100%";
      progressBar.setAttribute("aria-valuenow", 100);
      progressBar.classList.add('bg-success');
      progressBar.classList.remove('bg-danger');
    } else if (status === "文件存在") {
      progressBar.style.width = "100%";
      progressBar.setAttribute("aria-valuenow", 100);
      progressBar.classList.add('bg-warning');
      progressBar.classList.remove('bg-success');
    } else {
      progressBar.style.width = "100%";
      progressBar.setAttribute("aria-valuenow", 100);
      progressBar.classList.add('bg-danger');
      progressBar.classList.remove('bg-success');
    }
  }
</script>
